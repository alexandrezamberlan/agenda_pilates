{% extends 'core/base.html' %}
{% load bootstrap3 %}

{% block title %}
	{% bootstrap_icon 'play' %} Animação - {{ exercicio.descricao }}
{% endblock %}

{% block content %}
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
	
	<style>
		/* Estilo personalizado para animação */
		.exercicio-animation-container {
			background-color: #F8F5ED;
			min-height: 100vh;
			font-family: 'Montserrat', sans-serif;
			color: #2A9D8F;
		}
		
		.animation-header {
			background-color: #2A9D8F;
			color: white;
			padding: 20px;
			text-align: center;
			font-weight: 600;
			font-size: 24px;
		}
		
		.animation-content {
			padding: 40px 20px;
			text-align: center;
		}
		
		.exercise-info-panel {
			background: white;
			border-radius: 15px;
			padding: 30px;
			margin-bottom: 30px;
			box-shadow: 0 4px 15px rgba(0,0,0,0.1);
			border: 2px solid #2A9D8F;
		}
		
		.animation-area {
			background: white;
			border-radius: 15px;
			padding: 30px;
			box-shadow: 0 4px 15px rgba(0,0,0,0.1);
			border: 2px solid #2A9D8F;
			position: relative;
		}
		
		.pause-icon {
			position: absolute;
			top: 15px;
			right: 15px;
			font-size: 24px;
			color: #E76F51;
			cursor: pointer;
			background: none;
			border: none;
		}
		
		.instruction-text {
			font-size: 36px;
			font-weight: 700;
			text-transform: uppercase;
			color: #2A9D8F;
			margin: 20px 0;
		}
		
		.timer-text {
			font-size: 48px;
			font-weight: 700;
			color: #2A9D8F;
			margin: 20px 0;
		}
		
		.intensity-text {
			font-size: 24px;
			font-weight: 600;
			color: #2A9D8F;
		}
		
		.chart-container {
			margin: 30px 0;
			background: #F8F5ED;
			border-radius: 10px;
			padding: 20px;
		}
		
		.control-buttons {
			margin: 30px 0;
		}
		
		.btn-custom {
			background-color: #2A9D8F;
			color: white;
			border: none;
			padding: 15px 30px;
			margin: 0 10px;
			border-radius: 25px;
			font-weight: 600;
			font-size: 16px;
			transition: all 0.3s ease;
		}
		
		.btn-custom:hover {
			background-color: #258577;
			color: white;
		}
		
		.btn-custom:disabled {
			background-color: #ccc;
			color: #666;
		}
		
		.btn-finish {
			background-color: #E76F51;
			color: white;
			border: none;
			padding: 20px 40px;
			border-radius: 25px;
			font-weight: 700;
			font-size: 18px;
			text-transform: uppercase;
			margin-top: 20px;
		}
		
		.btn-finish:hover {
			background-color: #d85d44;
			color: white;
		}
		
		.footer-bar {
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			height: 15px;
			background-color: #2A9D8F;
		}
		
		.back-button {
			position: fixed;
			top: 20px;
			left: 20px;
			background-color: #2A9D8F;
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 15px;
			font-weight: 600;
			text-decoration: none;
		}
		
		.back-button:hover {
			background-color: #258577;
			color: white;
			text-decoration: none;
		}
	</style>

	<div class="exercicio-animation-container">
		<!-- Botão de Voltar -->
		<a href="{% url 'exercicio_list' %}" class="back-button">
			{% bootstrap_icon 'arrow-left' %} Voltar
		</a>
		
		<!-- Cabeçalho -->
		<div class="animation-header">
			ANIMAÇÃO: {{ exercicio.descricao }}
		</div>
		
		<!-- Conteúdo Principal -->
		<div class="animation-content">
			<div class="container">
				<div class="row">
					<div class="col-md-6">
						<!-- Informações do Exercício -->
						<div class="exercise-info-panel">
							<h4 style="color: #2A9D8F; font-weight: 700; margin-bottom: 20px;">INFORMAÇÕES DO EXERCÍCIO</h4>
							<p><strong>Descrição:</strong> {{ exercicio.descricao }}</p>
							<p><strong>Tempo de Contração:</strong> {{ exercicio.tempo }} segundos</p>
							<p><strong>Intensidade:</strong> {{ exercicio.intensidade }}%</p>
							<p><strong>Tempo Total:</strong> {{ tempo_total }} segundos</p>
							{% if exercicio.video %}
								<p><strong>Vídeo de Referência:</strong> 
									<a href="{{ exercicio.video }}" target="_blank" class="btn-custom" style="padding: 10px 20px; font-size: 14px;">
										{% bootstrap_icon 'film' %} Ver no YouTube
									</a>
								</p>
							{% endif %}
						</div>
					</div>
					
					<div class="col-md-6">
						<!-- Área da Animação -->
						<div class="animation-area">
							<button id="pauseBtn" class="pause-icon">||</button>
							
							<div class="instruction-text" id="instructionText">PREPARE-SE</div>
							<div class="timer-text" id="timerText">3</div>
							<div class="intensity-text" id="intensityText">0%</div>
							
							<!-- Container do Gráfico -->
							<div class="chart-container">
								<canvas id="exerciseChart" width="500" height="300"></canvas>
							</div>
							
							<!-- Controles -->
							<div class="control-buttons">
								<button id="playBtn" class="btn-custom">
									{% bootstrap_icon 'play' %} INICIAR
								</button>
								<button id="stopBtn" class="btn-custom" disabled>
									{% bootstrap_icon 'stop' %} PARAR
								</button>
							</div>
							
							<!-- Botão de Finalizar (hidden inicialmente) -->
							<button id="finishBtn" class="btn-finish" style="display: none;">
								CONCLUIR
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<!-- Barra de Rodapé -->
		<div class="footer-bar"></div>
	</div>

	<!-- Script da Nova Animação -->
	<script>
		// Configurações do exercício baseadas nos dados do Django
		const exercicioConfig = {
			descricao: "{{ exercicio.descricao|escapejs }}",
			tempo: {{ exercicio.tempo }},
			intensidade: {{ exercicio.intensidade }},
			tempoTotal: {{ tempo_total }}
		};

		class ExercicioAnimadorGrafico {
			constructor(canvasId, config) {
				this.canvas = document.getElementById(canvasId);
				this.ctx = this.canvas.getContext('2d');
				this.config = config;
				
				// Estado da animação
				this.isRunning = false;
				this.isPaused = false;
				this.currentPhaseIndex = 0;
				this.phaseStartTime = null;
				this.animationFrame = null;
				
				// Elementos DOM
				this.playBtn = document.getElementById('playBtn');
				this.pauseBtn = document.getElementById('pauseBtn');
				this.stopBtn = document.getElementById('stopBtn');
				this.finishBtn = document.getElementById('finishBtn');
				this.instructionText = document.getElementById('instructionText');
				this.timerText = document.getElementById('timerText');
				this.intensityText = document.getElementById('intensityText');
				
				// Criar plano de exercício
				this.exercisePlan = this.createExercisePlan();
				
				this.setupEventListeners();
				this.drawChart();
				this.updateDisplay();
			}
			
			createExercisePlan() {
				const plan = [];
				
				// Fase de preparação
				plan.push({
					type: 'PREPARE-SE',
					duration: 3,
					level: 0
				});
				
				// Uma repetição: contração + relaxamento
				plan.push({
					type: 'CONTRAIA ' + this.config.intensidade + '%',
					duration: this.config.tempo,
					level: this.config.intensidade / 100
				});
				
				plan.push({
					type: 'RELAXE',
					duration: this.config.tempo,
					level: 0
				});
				
				return plan;
			}
			
			setupEventListeners() {
				this.playBtn.addEventListener('click', () => this.start());
				this.pauseBtn.addEventListener('click', () => this.pause());
				this.stopBtn.addEventListener('click', () => this.stop());
				this.finishBtn.addEventListener('click', () => this.finish());
			}
			
			start() {
				if (this.isPaused) {
					this.isPaused = false;
				} else {
					this.isRunning = true;
					this.currentPhaseIndex = 0;
					this.phaseStartTime = Date.now();
				}
				
				this.playBtn.disabled = true;
				this.pauseBtn.disabled = false;
				this.stopBtn.disabled = false;
				
				this.animate();
			}
			
			pause() {
				this.isPaused = true;
				this.playBtn.disabled = false;
				this.pauseBtn.disabled = true;
				
				if (this.animationFrame) {
					cancelAnimationFrame(this.animationFrame);
				}
			}
			
			stop() {
				this.isRunning = false;
				this.isPaused = false;
				this.currentPhaseIndex = 0;
				
				this.playBtn.disabled = false;
				this.pauseBtn.disabled = true;
				this.stopBtn.disabled = true;
				this.finishBtn.style.display = 'none';
				
				if (this.animationFrame) {
					cancelAnimationFrame(this.animationFrame);
				}
				
				this.updateDisplay();
				this.drawChart();
			}
			
			finish() {
				// Voltar para a lista de exercícios
				window.location.href = "{% url 'exercicio_list' %}";
			}
			
			animate() {
				if (!this.isRunning || this.isPaused) return;
				
				const now = Date.now();
				const currentPhase = this.exercisePlan[this.currentPhaseIndex];
				
				if (!currentPhase) {
					// Treino finalizado
					this.finishExercise();
					return;
				}
				
				const phaseElapsed = (now - this.phaseStartTime) / 1000;
				const timeRemaining = Math.max(0, currentPhase.duration - phaseElapsed);
				
				if (phaseElapsed >= currentPhase.duration) {
					// Avançar para próxima fase
					this.currentPhaseIndex++;
					this.phaseStartTime = now;
				}
				
				this.updateDisplay(timeRemaining);
				this.drawChart(phaseElapsed / currentPhase.duration);
				
				this.animationFrame = requestAnimationFrame(() => this.animate());
			}
			
			finishExercise() {
				this.isRunning = false;
				this.instructionText.textContent = 'EXERCÍCIO FINALIZADO!';
				this.timerText.textContent = '✓';
				this.intensityText.textContent = 'CONCLUÍDO';
				
				this.playBtn.disabled = true;
				this.pauseBtn.disabled = true;
				this.stopBtn.disabled = true;
				this.finishBtn.style.display = 'inline-block';
				
				this.drawChart(1);
			}
			
			updateDisplay(timeRemaining = null) {
				const currentPhase = this.exercisePlan[this.currentPhaseIndex];
				
				if (currentPhase) {
					this.instructionText.textContent = currentPhase.type;
					this.timerText.textContent = timeRemaining !== null ? Math.ceil(timeRemaining) : currentPhase.duration;
					this.intensityText.textContent = Math.round(currentPhase.level * 100) + '%';
				} else {
					this.instructionText.textContent = 'PREPARE-SE';
					this.timerText.textContent = '3';
					this.intensityText.textContent = '0%';
				}
			}
			
			drawChart(phaseProgress = 0) {
				const ctx = this.ctx;
				const width = this.canvas.width;
				const height = this.canvas.height;
				
				// Limpar canvas
				ctx.clearRect(0, 0, width, height);
				
				// Configurações do gráfico
				const padding = 60;
				const chartWidth = width - 2 * padding;
				const chartHeight = height - 2 * padding;
				const chartBottom = height - padding;
				
				// Desenhar eixo Y e labels
				ctx.strokeStyle = '#2A9D8F';
				ctx.lineWidth = 2;
				ctx.font = '14px Montserrat';
				ctx.fillStyle = '#2A9D8F';
				ctx.textAlign = 'right';
				
				// Linha e label 100%
				const y100 = chartBottom - chartHeight;
				ctx.setLineDash([5, 5]);
				ctx.beginPath();
				ctx.moveTo(padding, y100);
				ctx.lineTo(width - padding, y100);
				ctx.stroke();
				ctx.fillText('100%', padding - 10, y100 + 5);
				
				// Linha e label 50%
				const y50 = chartBottom - chartHeight / 2;
				ctx.beginPath();
				ctx.moveTo(padding, y50);
				ctx.lineTo(width - padding, y50);
				ctx.stroke();
				ctx.fillText('50%', padding - 10, y50 + 5);
				
				// Linha e label 0% (sólida)
				const y0 = chartBottom;
				ctx.setLineDash([]);
				ctx.lineWidth = 3;
				ctx.beginPath();
				ctx.moveTo(padding, y0);
				ctx.lineTo(width - padding, y0);
				ctx.stroke();
				ctx.fillText('0%', padding - 10, y0 + 5);
				
				// Desenhar linha do gráfico
				this.drawExerciseLine(ctx, padding, chartBottom, chartWidth, chartHeight, phaseProgress);
			}
			
			drawExerciseLine(ctx, startX, baseY, chartWidth, chartHeight, phaseProgress) {
				const totalDuration = this.exercisePlan.reduce((sum, phase) => sum + phase.duration, 0);
				let cumulativeTime = 0;
				
				// Desenhar linha futura (toda a sequência)
				ctx.strokeStyle = '#2A9D8F';
				ctx.lineWidth = 3;
				ctx.setLineDash([]);
				ctx.beginPath();
				
				let firstPoint = true;
				for (let i = 0; i < this.exercisePlan.length; i++) {
					const phase = this.exercisePlan[i];
					const x1 = startX + (cumulativeTime / totalDuration) * chartWidth;
					const y1 = baseY - (phase.level * chartHeight);
					
					if (firstPoint) {
						ctx.moveTo(x1, y1);
						firstPoint = false;
					} else {
						ctx.lineTo(x1, y1);
					}
					
					cumulativeTime += phase.duration;
					const x2 = startX + (cumulativeTime / totalDuration) * chartWidth;
					ctx.lineTo(x2, y1);
				}
				ctx.stroke();
				
				// Calcular posição atual da bolinha
				let currentTime = 0;
				for (let i = 0; i < this.currentPhaseIndex; i++) {
					currentTime += this.exercisePlan[i].duration;
				}
				
				if (this.currentPhaseIndex < this.exercisePlan.length) {
					const currentPhase = this.exercisePlan[this.currentPhaseIndex];
					currentTime += phaseProgress * currentPhase.duration;
					
					// Desenhar bolinha vermelha
					const ballX = startX + (currentTime / totalDuration) * chartWidth;
					const ballY = baseY - (currentPhase.level * chartHeight);
					
					ctx.fillStyle = '#E76F51';
					ctx.beginPath();
					ctx.arc(ballX, ballY, 8, 0, 2 * Math.PI);
					ctx.fill();
				}
			}
		}
		
		// Inicializar animação quando a página carregar
		document.addEventListener('DOMContentLoaded', function() {
			new ExercicioAnimadorGrafico('exerciseChart', exercicioConfig);
		});
	</script>
{% endblock %} 